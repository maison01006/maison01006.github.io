<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë³´ìƒ ì•± - ì‹¤íŒ¨ ì¡°ì •</title>
    <link rel="stylesheet" href="../css/global_style.css" />
  </head>
  <body>
    <header class="header">
      <button class="button-icon" onclick="history.back()">
        <img
          src="../assets/icons/back.svg"
          alt="ë’¤ë¡œê°€ê¸°"
          width="24"
          height="24"
        />
      </button>
      <h1>ì‹¤íŒ¨ ì¡°ì •</h1>
    </header>
    <main>
      <section class="incomplete-todos">
        <h2>ë¯¸ì™„ë£Œëœ í•  ì¼</h2>
        <ul id="incompleteList"></ul>
      </section>

      <section class="probability-adjustment">
        <h2>í™•ë¥  ì¡°ì •</h2>
        <p>í˜„ì¬ í™•ë¥ : <span id="currentProbability">0</span>%</p>
        <button id="watchAdButton" class="button-primary">
          ê´‘ê³  ë³´ê³  í™•ë¥  ì˜¬ë¦¬ê¸°
        </button>
      </section>

      <section class="fail-stack">
        <h2>ì‹¤íŒ¨ ìŠ¤íƒ</h2>
        <div id="failStackDisplay"></div>
      </section>

      <div class="action-buttons">
        <button id="skipButton" class="button-secondary">ê±´ë„ˆë›°ê¸°</button>
      </div>
    </main>

    <script src="../js/utils.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/reward.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const incompleteList = document.getElementById("incompleteList");
        const currentProbability =
          document.getElementById("currentProbability");
        const failStack = document.getElementById("failStackDisplay");
        const watchAdBtn = document.getElementById("watchAdButton");
        const skipBtn = document.getElementById("skipButton");

        // ì–´ì œ ë‚ ì§œ ê³„ì‚°
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split("T")[0];

        // ë¯¸ì™„ë£Œ Todo ë¡œë“œ
        async function loadIncompleteTodos() {
          const todos = await storage.getTodos(yesterdayStr);
          const incompleteTodos = todos.filter((todo) => !todo.completed);

          incompleteList.innerHTML = "";

          if (incompleteTodos.length === 0) {
            incompleteList.innerHTML =
              '<li class="empty-message">ë¯¸ì™„ë£Œ Todoê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
            return;
          }

          incompleteTodos.forEach((todo) => {
            const li = document.createElement("li");
            li.className = "list-item";
            li.innerHTML = `
              <div class="todo-info">
                <div class="todo-title">${todo.text}</div>
              </div>
            `;
            incompleteList.appendChild(li);
          });
        }

        // í™•ë¥  í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateProbabilityDisplay() {
          const probability = rewardManager.calculateProbability();
          currentProbability.textContent = probability;
        }

        // ê½ ìŠ¤íƒ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateFailStackDisplay() {
          const stackCount = rewardManager.getFailStack();
          failStack.innerHTML = "ğŸ”¥".repeat(stackCount);
        }

        // ê´‘ê³  ë³´ê¸° ë²„íŠ¼
        watchAdBtn.addEventListener("click", () => {
          // ì‹¤ì œ ê´‘ê³  êµ¬í˜„ í•„ìš”
          alert("ê´‘ê³  ì‹œì²­ ì‹œ í™•ë¥ ì´ 10% ì¦ê°€í•©ë‹ˆë‹¤.");
          rewardManager.resetFailStack();
          window.location.href = "index.html";
        });

        // ê±´ë„ˆë›°ê¸° ë²„íŠ¼
        skipBtn.addEventListener("click", () => {
          window.location.href = "index.html";
        });

        // ì´ˆê¸°í™”
        await loadIncompleteTodos();
        updateProbabilityDisplay();
        updateFailStackDisplay();
      });
    </script>
  </body>
</html>
